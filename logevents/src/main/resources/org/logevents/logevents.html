<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Log Event Viewer | logevents</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            margin: 0;
            height: 100vh;
        }

        main {
            overflow: auto;
        }

        nav form {
            display: flex;
        }
        main td button {
            width: 3em;
            text-align: center;
            margin: auto;
        }

        .expanded {
            border: 1px solid red;
        }'

    </style>
</head>
<body>
    <header>
        <h1>LogEvents</h1>
    </header>
    <nav>
        <form id="logEventsFilter" method="get">
            <fieldset id="dateTime">
                <input type="time" name="time" id="time">
                <button>Update</button>
                <select name="interval">
                    <option value="PT5S">+/- 5 seconds</option>
                    <option value="PT1M">+/- 1 minute</option>
                    <option value="PT5M" selected>+/- 5 minutes</option>
                    <option value="PT15M">+/- 15 minutes</option>
                    <option value="PT1H">+/- 1 hour</option>
                </select>
                <select name="level">
                    <option value="TRACE">TRACE</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARN">WARN</option>
                    <option value="ERROR">ERROR</option>
                </select>
            </fieldset>
            <fieldset id="threads">
            </fieldset>
            <fieldset id="loggers">
            </fieldset>
            <fieldset id="markers">
            </fieldset>
            <fieldset id="mdcFilter">
                <div>
                    <label>
                        User
                        <select name="mdc.user">
                            <option value="">all</option>
                            <option value="user 1">user 1</option>
                        </select>
                    </label>
                </div>
            </fieldset>
            <fieldset>
                <button id="clearButton">Clear</button>
            </fieldset>
        </form>
    </nav>
    <main id="main">

    </main>
</body>
<script>
function tableCell(textContent) {
    const td = document.createElement("td");
    td.innerHTML = textContent;
    return td;
}

let logEvents = [];

function showLogEventTable() {
    console.log({logEvents});
    const table = document.createElement("table");
    for (const index in logEvents) {
        const logEvent = logEvents[index];
        const tr = document.createElement("tr");
        tr.dataset.eventIndex = index;

        const time = logEvent.time.split("T")[1];

        const buttonTd = document.createElement("td");
        buttonTd.innerHTML = "<button>" + logEvent.levelIcon + "</button>";
        tr.appendChild(buttonTd);
        const tdIcon = document.createElement("td");
        if (logEvent.throwable) {
            tdIcon.innerHTML += " ❗";
        }
        tr.appendChild(tdIcon);

        tr.appendChild(tableCell(time));
        tr.appendChild(tableCell(logEvent.abbreviatedLogger));
        tr.appendChild(tableCell(logEvent.formattedMessage));

        table.appendChild(tr);
    }
    const main = document.getElementById("main");
    main.innerHTML = "";
    main.appendChild(table);
}

function checkbox(name, value, currentFilter) {
    const checkboxDiv = document.createElement("div");
    const checked = (currentFilter.getAll(name).indexOf(value) >= 0) ? ' checked="checked"' : "";
    checkboxDiv.innerHTML = `<label><input type="checkbox" name=${name} value="${value}" ${checked}>${value}</label>`;
    return checkboxDiv;
}

function showFacets(facets) {
    const dateTimeFieldset = document.getElementById("dateTime");
    const loggersFieldset = document.getElementById("loggers");
    const markersFieldset = document.getElementById("markers");
    const currentFilter = new URLSearchParams(window.location.search.substr(1));

    document.getElementById("time").value = currentFilter.get("time");
    const selectedInterval = document.querySelector("[name=interval] [value=" + currentFilter.get("interval") + "]");
    if (selectedInterval) {
        selectedInterval.selected = true;
    } else {
        const intervalSelect = document.querySelector("[name=interval]");
        const separator = document.createElement("option");
        separator.innerText = "--------------";
        separator.setAttribute("disabled", "disable");
        intervalSelect.insertBefore(separator, intervalSelect.firstChild);
        const option = document.createElement("option");
        option.innerText = currentFilter.get("interval");
        option.setAttribute("selected", "selected");
        intervalSelect.insertBefore(option, intervalSelect.firstChild);
    }
    const selectedLevel = document.querySelector("[name=level] [value=" + currentFilter.get("level") + "]");
    if (selectedLevel) {
        selectedLevel.selected = true;
    }

    if (currentFilter.get("date")) {
        const dateInput = document.createElement("input");
        dateInput.setAttribute("type", "hidden");
        dateInput.setAttribute("name", "date");
        dateInput.setAttribute("value", currentFilter.get("date"));
        dateTimeFieldset.appendChild(dateInput);
    }

    markersFieldset.innerHTML = "";

    for (const marker of facets.markers) {
        markersFieldset.appendChild(checkbox("marker", marker, currentFilter));
    }

    const threads = document.getElementById("threads");
    const threadsSelect = document.createElement("select");
    threadsSelect.setAttribute("name", "thread");
    const emptyOption = document.createElement("option");
    threadsSelect.appendChild(emptyOption);
    for (const thread of facets.threads) {
        const threadOption = document.createElement("option");
        if (currentFilter.getAll("thread").indexOf(thread) >= 0) {
            threadOption.setAttribute("selected", "selected");
        }
        threadOption.innerText = thread;
        threadsSelect.appendChild(threadOption);
    }
    threads.innerHTML = "";
    threads.appendChild(threadsSelect);

    loggersFieldset.innerHTML = "";
    for (const logger of facets.loggers) {
        loggersFieldset.appendChild(checkbox("logger", logger, currentFilter));
    }

    const mdcFilter = document.getElementById("mdcFilter");
    mdcFilter.innerHTML = "";
    for (const mdcEntry of facets.mdc) {
        const mdcLabel = document.createElement("label");
        mdcLabel.innerText = mdcEntry.name + ": ";

        const mdcSelect = document.createElement("select");
        mdcSelect.setAttribute("name", "mdc[" + mdcEntry.name + "]");

        const emptyMdcOption = document.createElement("option");
        mdcSelect.appendChild(emptyMdcOption);

        for (const alternative of mdcEntry.values) {
            const mdcOption = document.createElement("option");
            if (currentFilter.getAll("mdc[" + mdcEntry.name + "]").indexOf(alternative) >= 0) {
                mdcOption.setAttribute("selected", "selected");
            }
            mdcOption.innerText = alternative;
            mdcSelect.appendChild(mdcOption);
        }

        mdcLabel.appendChild(mdcSelect);
        const mdcDiv = document.createElement("div");
        mdcDiv.appendChild(mdcLabel);

        mdcFilter.appendChild(mdcDiv);
    }
}

function listItem(header, text, filter) {
    const li = document.createElement("li");
    if (filter) {
        const currentFilter = new URLSearchParams(window.location.search.substr(1));
        const time = currentFilter.get("time");
        const interval = currentFilter.get("interval");
        const level = currentFilter.get("level");
        li.innerHTML = `<strong>${header}:</strong>
            <a href="?time=${time}&interval=${interval}&level=${level}&${filter}=${text}"
            >${text}</a>`;
    } else {
        li.innerHTML = `<strong>${header}:</strong> ${text}`;
    }
    return li;
}

function detailRow(event) {
    const expandedRow = document.createElement("tr");
    expandedRow.dataset.isDetail = true;

    const td = document.createElement("td");
    td.setAttribute("colspan", "100%");

    const ul = document.createElement("ul");
    ul.appendChild(listItem("Logger", event.logger, "logger"));
    ul.appendChild(listItem("Thread", event.thread, "thread"));
    if (event.marker) {
        ul.appendChild(listItem("Marker", event.marker, "marker"));
    }

    if (event.mdc && Object.entries(event.mdc).length) {
        const mdcList = document.createElement("li");
        mdcList.innerHTML = "<strong>MDC</strong>";
        const mdcUl = document.createElement("ul");
        mdcList.appendChild(mdcUl);

        for (const mdc of event.mdc) {
            mdcUl.appendChild(listItem(mdc.name, mdc.value, "mdc[" + mdc.name + "]"));
        }

        ul.appendChild(mdcList);
    }

    if (event.throwable) {
        ul.appendChild(listItem("Exception", event.throwable));

        const stackTrace = document.createElement("pre");
        for (const element of event.stackTrace) {
            stackTrace.innerHTML += element.className + "#" + element.methodName + "\n";
        }
        ul.appendChild(stackTrace);
    }
    td.appendChild(ul);
    expandedRow.appendChild(td);

    return expandedRow;
}


function expandCollapseEventRow(targetRow) {
    const eventIndex = targetRow.dataset.eventIndex;

    if (targetRow.nextSibling && targetRow.nextSibling.dataset.isDetail) {
        targetRow.classList.remove("expanded");
        targetRow.parentElement.removeChild(targetRow.nextSibling);
    } else {
        targetRow.classList.add("expanded");
        targetRow.parentElement.insertBefore(detailRow(logEvents[eventIndex]), targetRow.nextSibling);
    }
}


async function fetchEvents() {
    const response = await fetch("events" + window.location.search);
    if (response.ok) {
        console.log(response);
        const json = await response.json();
        logEvents = json.events;
        showLogEventTable();
        showFacets(json.facets);
    } else if (response.status === 401) {
        window.location = "login" + window.location.search;
    } else {
        console.log(response);
    }
}

const main = document.getElementById("main");
main.addEventListener("click", e => {
    if (e.target.tagName === "BUTTON") {
        const targetRow = e.target.parentElement.parentElement;
        expandCollapseEventRow(targetRow);
    }
});

const logEventsFilter = document.getElementById("logEventsFilter");
const clearButton = document.getElementById("clearButton");
const timeInput = document.getElementById("time");

logEventsFilter.addEventListener("change", e => {
    if (e.target.tagName === "SELECT" || (e.target.tagName === "INPUT" && e.target.type === "checkbox")) {
        window.location.search = new URLSearchParams(new FormData(logEventsFilter)).toString();
    }
});

clearButton.addEventListener("click", e => {
    const d = new Date(),
        h = (d.getHours()<10?'0':'') + d.getHours(),
        m = (d.getMinutes()<10?'0':'') + d.getMinutes();
    window.location.search = "time=" + h + ':' + m + "&interval=PT5M&level=TRACE";
    e.preventDefault();
});


if (!window.location.search) {
    const d = new Date(),
        h = (d.getHours()<10?'0':'') + d.getHours(),
        m = (d.getMinutes()<10?'0':'') + d.getMinutes();
    timeInput.value = h + ':' + m;
    window.location.search = new URLSearchParams(new FormData(logEventsFilter)).toString();
} else {
    fetchEvents();
}
</script>
</html>