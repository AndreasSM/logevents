<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            display: flex;
            margin: 0;
            flex-direction: column;
            height: 100vh;
        }

        main, nav {
          transition: 0.5s;
        }

        main {
            overflow: auto;
        }

        nav {
          height: 100%;
          width: 0;
          position: fixed;
          z-index: 10;
          top: 0;
          left: 0;
          background-color: #fff;
          overflow-x: hidden;
          padding-top: 60px;
          border: 1px solid gray;
        }

        nav form {
            overflow-x: hidden;
            width: 250px;
        }

        .drawerOpen nav {
          width: 250px;
        }

        .pushContent.drawerOpen main {
          margin-left: 250px;
        }

        nav a {
          padding: 8px 8px 8px 32px;
          text-decoration: none;
          font-size: 25px;
          display: block;
        }

        nav .closeDrawer {
          position: absolute;
          top: 0;
          right: 25px;
          font-size: 36px;
          margin-left: 50px;
        }

        .event {
            border: 1px solid gray;
            overflow-x: hidden;
            white-space: nowrap;
        }

        .event button {
            width: 3em;
            margin-right: 0.5em;
        }

        .event .loggerName {
            font-weight: bold;
        }

        .event .details {
            display: none;
            transition: 0.5s;
        }

        .displayDetails.event .details {
            display: block;
            transition: 0.5s;
        }

        .formattedMessage {
            display: inline;
        }

        .formattedMessage .argument {
            text-decoration: underline;
        }

        .displayDetails.event .formattedMessage {
            white-space: normal;
        }

        @media screen and (max-height: 450px) {
          nav {padding-top: 15px;}
          nav a {font-size: 18px;}
        }

        #overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .drawerOpen #overlay {
            z-index: 1;
        }

    </style>
</head>
<body>

    <nav>
        <a href="#" class="closeDrawer" onclick="toggleNav(event)">&times;</a>
        <form id="logEventsFilter" method="get">
            <fieldset id="dateTime">
                <input type="time" name="time" id="time">
                <select name="interval">
                    <option value="PT5S">+/- 5 sec</option>
                    <option value="PT1M">+/- 1 min</option>
                    <option value="PT5M" selected>+/- 5 min</option>
                    <option value="PT15M">+/- 15 min</option>
                    <option value="PT1H">+/- 1 hr</option>
                </select>
                <input type="hidden" name="timezoneOffset" id="timezoneOffset" />
                <button>Update</button>
            </fieldset>
            <fieldset>
                <select name="level">
                    <option value="TRACE">TRACE</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARN">WARN</option>
                    <option value="ERROR">ERROR</option>
                </select>
            </fieldset>
            <fieldset id="threads"></fieldset>
            <fieldset id="loggers"></fieldset>
            <fieldset id="markers"></fieldset>
            <fieldset id="nodes"></fieldset>
            <fieldset id="applications"></fieldset>
            <fieldset id="mdcFilter">
                <div>
                    <label>
                        User
                        <select name="mdc.user">
                            <option value="">all</option>
                            <option value="user 1">user 1</option>
                        </select>
                    </label>
                </div>
            </fieldset>
            <fieldset>
                <button id="clearButton">Clear</button>
            </fieldset>
        </form>
    </nav>
    <header>
        <a href="#" onclick="toggleNav(event)">&#9776; Filter</a>
    </header>
    <main>
    </main>
    <div id="overlay" onclick="toggleNav(event)"></div>
</body>
<script>
const body = document.querySelector("body");
const logEventsFilter = document.getElementById("logEventsFilter");

function toggleNav(e) {
    body.classList.toggle("drawerOpen");
    e.preventDefault();
}

function hourMinute(instant) {
    return instant.getHours().toString().padStart(2, "0") +
            ":" + instant.getMinutes().toString().padStart(2, "0");
}

function hourMinuteSecond(instant) {
    return instant.getHours().toString().padStart(2, "0") +
            ":" + instant.getMinutes().toString().padStart(2, "0") +
            ":" + instant.getSeconds().toString().padStart(2, "0");
}


function createElementWithText(tagName, textContent, className) {
    const element = document.createElement(tagName);
    element.innerText = textContent;
    if (className) {
        element.classList.add(className);
    }
    return element;
}

function showLogEventTable() {
    function listItem(header, text, filter) {
        const li = document.createElement("li");
        if (filter) {
            const currentFilter = new URLSearchParams(window.location.search.substr(1));
            const time = currentFilter.get("time");
            const interval = currentFilter.get("interval");
            const level = currentFilter.get("level");
            const timezoneOffset = currentFilter.get("timezoneOffset");
            li.innerHTML = `<strong>${header}:</strong>
                <a href="?time=${time}&interval=${interval}&level=${level}&${filter}=${text}&timezoneOffset=${timezoneOffset}"
                >${text}</a>`;
        } else {
            li.innerHTML = `<strong>${header}:</strong> ${text}`;
        }
        return li;
    }

    const events = document.createElement("div");
    for (const index in logEvents) {
        const logEvent = logEvents[index];
        const eventCard = document.createElement("div");
        eventCard.classList.add("event");
        eventCard.dataset.eventIndex = index;

        eventCard.appendChild(createElementWithText("button", logEvent.levelIcon));
        eventCard.appendChild(document.createTextNode(hourMinuteSecond(new Date(logEvent.time))));
        eventCard.appendChild(createElementWithText("span", " [" + logEvent.abbreviatedLogger + "]: ", "loggerName"));

        if (logEvent.throwable) {
            eventCard.appendChild(document.createTextNode(" \u2757"));
        }

        const formattedMessage = document.createElement("div");
        formattedMessage.classList.add("formattedMessage");
        for (const messagePart of logEvent.message) {
            formattedMessage.appendChild(createElementWithText("span", messagePart.text, messagePart.type));
        }
        eventCard.appendChild(formattedMessage);

        const eventDetails = document.createElement("div");
        eventDetails.classList.add("details");
        const ul = document.createElement("ul");
        ul.appendChild(listItem("Logger", logEvent.logger, "logger"));
        ul.appendChild(listItem("Thread", logEvent.thread, "thread"));
        ul.appendChild(listItem("Node", logEvent.node, "node"));
        if (logEvent.marker) {
            ul.appendChild(listItem("Marker", logEvent.marker, "marker"));
        }
        if (logEvent.mdc && Object.entries(logEvent.mdc).length) {
            const mdcList = document.createElement("li");
            mdcList.innerHTML = "<strong>MDC</strong>";
            const mdcUl = document.createElement("ul");
            mdcList.appendChild(mdcUl);

            for (const mdc of logEvent.mdc) {
                mdcUl.appendChild(listItem(mdc.name, mdc.value, "mdc[" + mdc.name + "]"));
            }

            ul.appendChild(mdcList);
        }
        if (logEvent.throwable) {
            ul.appendChild(listItem("Exception", logEvent.throwable));

            const stackTrace = document.createElement("pre");
            for (const element of logEvent.stackTrace) {
                if (element.sourceLink) {
                    stackTrace.innerHTML += "<a target='source' href='" + element.sourceLink + "'>" + element.className + "#" + element.methodName + "</a>";
                } else if (element.className) {
                    stackTrace.innerHTML += element.className + "#" + element.methodName + "("
                        + element.fileName + ":" + element.lineNumber + ")";
                }
                if (element.ignoredFrames > 0) {
                    stackTrace.innerHTML += "[" + element.ignoredFrames + " skipped]";
                }
                stackTrace.innerHTML += "\n";
            }
            ul.appendChild(stackTrace);
        }

        eventDetails.appendChild(ul);
        eventCard.appendChild(eventDetails);

        events.appendChild(eventCard);
    }
    const main = document.querySelector("main");
    main.innerHTML = "";
    main.appendChild(events);
}

function showFacets(facets) {
    const currentFilter = new URLSearchParams(window.location.search.substr(1));

    function checkbox(name, value, text) {
        const checkboxDiv = document.createElement("div");
        const checked = (currentFilter.getAll(name).indexOf(value) >= 0) ? ' checked="checked"' : "";
        checkboxDiv.innerHTML = `<label><input type="checkbox" name=${name} value="${value}" ${checked}>${text || value}</label>`;
        return checkboxDiv;
    }

    function option(name, value, text) {
        const option = document.createElement("option");
        if (value) {
            option.setAttribute("value", value);
            if (currentFilter.getAll(name).indexOf(value) >= 0) {
                option.setAttribute("selected", "selected");
            }
            option.innerText = text || value;
        }
        return option;
    }

    const dateTimeFieldset = document.getElementById("dateTime");
    const loggersFieldset = document.getElementById("loggers");
    const markersFieldset = document.getElementById("markers");
    const nodesFieldset = document.getElementById("nodes");
    const applicationsFieldset = document.getElementById("applications");

    document.getElementById("time").value = currentFilter.get("time");
    const selectedInterval = document.querySelector("[name=interval] [value=" + currentFilter.get("interval") + "]");
    if (selectedInterval) {
        selectedInterval.selected = true;
    } else {
        const intervalSelect = document.querySelector("[name=interval]");
        const separator = createElementWithText("option", "--------------");
        separator.setAttribute("disabled", "disable");
        intervalSelect.insertBefore(separator, intervalSelect.firstChild);
        const option = createElementWithText("option", currentFilter.get("interval"));
        option.setAttribute("selected", "selected");
        intervalSelect.insertBefore(option, intervalSelect.firstChild);
    }
    const selectedLevel = document.querySelector("[name=level] [value=" + currentFilter.get("level") + "]");
    if (selectedLevel) {
        selectedLevel.selected = true;
    }

    if (currentFilter.get("date")) {
        const dateInput = document.createElement("input");
        dateInput.setAttribute("type", "hidden");
        dateInput.setAttribute("name", "date");
        dateInput.setAttribute("value", currentFilter.get("date"));
        dateTimeFieldset.appendChild(dateInput);
    }
    if (currentFilter.get("timezoneOffset")) {
       document.getElementById("timezoneOffset").value = currentFilter.get("timezoneOffset");
    }

    markersFieldset.innerHTML = "";
    for (const marker of facets.markers) {
        markersFieldset.appendChild(checkbox("marker", marker));
    }

    const threads = document.getElementById("threads");
    const threadsSelect = document.createElement("select");
    threadsSelect.setAttribute("name", "thread");
    threadsSelect.appendChild(option("thread"));
    for (const thread of facets.threads) {
        threadsSelect.appendChild(option("thread", thread));
    }
    threads.innerHTML = "";
    threads.appendChild(threadsSelect);

    loggersFieldset.innerHTML = "";
    for (const logger of facets.loggers) {
        loggersFieldset.appendChild(checkbox("logger", logger.name, logger.abbreviatedName));
    }
    nodesFieldset.innerHTML = "";
    for (const node of facets.nodes) {
        nodesFieldset.appendChild(checkbox("node", node));
    }
    applicationsFieldset.innerHTML = "";
    for (const node of facets.applications) {
        applicationsFieldset.appendChild(checkbox("application", node));
    }

    const mdcFilter = document.getElementById("mdcFilter");
    mdcFilter.innerHTML = "";
    for (const mdcEntry of facets.mdc) {
        const mdcLabel = createElementWithText("label", mdcEntry.name + ": ");

        const mdcSelect = document.createElement("select");
        mdcSelect.setAttribute("name", "mdc[" + mdcEntry.name + "]");

        const emptyMdcOption = document.createElement("option");
        mdcSelect.appendChild(emptyMdcOption);

        for (const alternative of mdcEntry.values) {
            mdcSelect.appendChild(option("mdc[" + mdcEntry.name + "]", alternative));
        }

        mdcLabel.appendChild(mdcSelect);
        const mdcDiv = document.createElement("div");
        mdcDiv.appendChild(mdcLabel);

        mdcFilter.appendChild(mdcDiv);
    }
}


async function fetchEvents() {
    const response = await fetch("events" + window.location.search);
    if (response.ok) {
        const json = await response.json();
        logEvents = json.events;
        showLogEventTable();
        showFacets(json.facets);
    } else if (response.status === 401) {
        window.location = "login" + window.location.search;
    } else {
        console.error(response);
    }
}

const main = document.querySelector("main");
main.addEventListener("click", e => {
    if (e.target.tagName === "BUTTON") {
        const targetCard = e.target.parentElement;
        targetCard.classList.toggle("displayDetails");
    }
});

logEventsFilter.addEventListener("change", e => {
    if (e.target.tagName === "SELECT" || (e.target.tagName === "INPUT" && e.target.type === "checkbox")) {
        window.location.search = new URLSearchParams(new FormData(logEventsFilter)).toString();
    }
});

const clearButton = document.getElementById("clearButton");
clearButton.addEventListener("click", e => {
    const d = new Date();
    window.location.search = "time=" + hourMinute(new Date()) + "&interval=PT5M&level=TRACE&timezoneOffset=" + d.getTimezoneOffset();
    e.preventDefault();
});


if (!window.location.search) {
    const d = new Date();
    document.getElementById("time").value = hourMinute(d);
    document.getElementById("timezoneOffset").value = d.getTimezoneOffset();
    window.location.search = new URLSearchParams(new FormData(logEventsFilter)).toString();
} else {
    const currentFilter = new URLSearchParams(window.location.search.substr(1));
    if (!currentFilter.get("time") && currentFilter.get("instant")) {
        const instant = new Date(currentFilter.get("instant"));
        currentFilter.delete("instant");
        currentFilter.set("time", hourMinuteSecond(instant));
        currentFilter.set("timezoneOffset", instant.getTimezoneOffset());
        window.location.search = currentFilter;
    } else {
        fetchEvents();
    }
}
</script>
</html>